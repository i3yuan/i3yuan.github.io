<!DOCTYPE HTML>
<html lang="zh-CN">


<head>
    <meta charset="utf-8">
    <meta name="referrer" content="no-referrer"/>
    <meta name="keywords" content="基于.NetCore3.1系列 —— 认证授权方案之JwtBearer认证, 艾三元">
    <meta name="description" content="">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <!-- Global site tag (gtag.js) - Google Analytics -->


    <title>基于.NetCore3.1系列 —— 认证授权方案之JwtBearer认证 | 艾三元</title>
    <link rel="icon" type="image/png" href="/favicon.png">

    <link rel="stylesheet" type="text/css" href="/libs/awesome/css/all.css">
    <link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="/css/matery.css">
    <link rel="stylesheet" type="text/css" href="/css/my.css">

    <script src="/libs/jquery/jquery.min.js"></script>

<meta name="generator" content="Hexo 5.1.1"><link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css"></head>


<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">艾三元</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a>
<ul class="right nav-menu">
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/" class="waves-effect waves-light">
      
      <i class="fas fa-home" style="zoom: 0.6;"></i>
      
      <span>首页</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/tags" class="waves-effect waves-light">
      
      <i class="fas fa-tags" style="zoom: 0.6;"></i>
      
      <span>标签</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/categories" class="waves-effect waves-light">
      
      <i class="fas fa-bookmark" style="zoom: 0.6;"></i>
      
      <span>分类</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/archives" class="waves-effect waves-light">
      
      <i class="fas fa-archive" style="zoom: 0.6;"></i>
      
      <span>归档</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/about" class="waves-effect waves-light">
      
      <i class="fas fa-user-circle" style="zoom: 0.6;"></i>
      
      <span>关于</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a target="_blank" rel="noopener" href="http://i3yuan.cnblogs.com" class="waves-effect waves-light">
      
      <i class="fas fa-blog" style="zoom: 0.6;"></i>
      
      <span>博客</span>
    </a>
    
  </li>
  
  <li>
    <a href="#searchModal" class="modal-trigger waves-effect waves-light">
      <i id="searchIcon" class="fas fa-search" title="搜索" style="zoom: 0.85;"></i>
    </a>
  </li>
</ul>


<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">艾三元</div>
        <div class="logo-desc">
            
            Never really desperate, only the lost of the soul.
            
        </div>
    </div>

    

    <ul class="menu-list mobile-menu-list">
        
        <li class="m-nav-item">
	  
		<a href="/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-home"></i>
			
			首页
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/tags" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-tags"></i>
			
			标签
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/categories" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-bookmark"></i>
			
			分类
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/archives" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-archive"></i>
			
			归档
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/about" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-user-circle"></i>
			
			关于
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a target="_blank" rel="noopener" href="http://i3yuan.cnblogs.com" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-blog"></i>
			
			博客
		</a>
          
        </li>
        
        
        <li><div class="divider"></div></li>
        <li>
            <a href="https://github.com/i3yuan" class="waves-effect waves-light" target="_blank">
                <i class="fab fa-github-square fa-fw"></i>Fork Me
            </a>
        </li>
        
    </ul>
</div>


        </div>

        
            <style>
    .nav-transparent .github-corner {
        display: none !important;
    }

    .github-corner {
        position: absolute;
        z-index: 10;
        top: 0;
        right: 0;
        border: 0;
        transform: scale(1.1);
    }

    .github-corner svg {
        color: #0f9d58;
        fill: #fff;
        height: 64px;
        width: 64px;
    }

    .github-corner:hover .octo-arm {
        animation: a 0.56s ease-in-out;
    }

    .github-corner .octo-arm {
        animation: none;
    }

    @keyframes a {
        0%,
        to {
            transform: rotate(0);
        }
        20%,
        60% {
            transform: rotate(-25deg);
        }
        40%,
        80% {
            transform: rotate(10deg);
        }
    }
</style>

<a href="https://github.com/i3yuan" class="github-corner tooltipped hide-on-med-and-down" target="_blank"
   data-tooltip="Fork Me" data-position="left" data-delay="50">
    <svg viewBox="0 0 250 250" aria-hidden="true">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
        <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
              fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
        <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
              fill="currentColor" class="octo-body"></path>
    </svg>
</a>
        
    </nav>

</header>

    



<div class="bg-cover pd-header post-cover" style="background-image: url('/medias/featureimages/48.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <h1 class="description center-align post-title">基于.NetCore3.1系列 —— 认证授权方案之JwtBearer认证</h1>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        width: 345px;
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        margin: 35px 0 15px 0;
        padding-left: 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content {
        height: calc(100vh - 250px);
        overflow: auto;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;

        position: absolute;
        right: 23.5vw;
        display: block;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 15px;
        bottom: 76px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/net-core/">
                                <span class="chip bg-color">.net core</span>
                            </a>
                        
                            <a href="/tags/JWT%E8%AE%A4%E8%AF%81%E6%8E%88%E6%9D%83/">
                                <span class="chip bg-color">JWT认证授权</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fas fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/DotCore-C/" class="post-category">
                                DotCore/C#
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-minus fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2020-06-19
                </div>
                

                

                

                

                
            </div>
        </div>
        <hr class="clearfix">
        <div class="card-content article-card-content">
            <div id="articleContent">
                <h1 id="基于-NetCore3-1系列-——-认证授权方案之JwtBearer认证"><a href="#基于-NetCore3-1系列-——-认证授权方案之JwtBearer认证" class="headerlink" title="基于.NetCore3.1系列 —— 认证授权方案之JwtBearer认证"></a>基于.NetCore3.1系列 —— 认证授权方案之JwtBearer认证</h1><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p><strong>回顾</strong>：<a target="_blank" rel="noopener" href="https://www.cnblogs.com/i3yuan/p/11519431.html">认证方案之初步认识JWT</a></p>
<p>在现代Web应用程序中，即分为前端与后端两大部分。当前前后端的趋势日益剧增，前端设备（手机、平板、电脑、及其他设备）层出不穷。因此，为了方便满足前端设备与后端进行通讯，就必须有一种统一的机制。所以导致API架构的流行。而<strong>RESTful API</strong>这个API设计思想理论也就成为目前互联网应用程序比较欢迎的一套方式。</p>
<p>这种API架构思想的引入，因此，我们就需要考虑用一种标准的，通用的，无状态的，与语言无关的身份认证方式来实现API接口的认证。</p>
<p>HTTP提供了一套标准的<strong>身份验证框架</strong>：服务端可以用来针对客户端的请求发送质询(challenge)，客户端根据质询提供应答身份验证凭证。</p>
<p><strong>质询与应答的工作流程</strong>如下：服务端向客户端返回401（Unauthorized，未授权）状态码，并在WWW-Authenticate头中添加如何进行验证的信息，其中至少包含有一种质询方式。然后客户端可以在请求中添加Authorization头进行验证，其Value为身份验证的凭证信息。</p>
<p>在本文中，将要介绍的是以Jwt Bearer方式进行认证。<br><a target="_blank" rel="noopener" href="https://img2020.cnblogs.com/blog/1576550/202006/1576550-20200618222306107-264946586.png"><img src="https://img2020.cnblogs.com/blog/1576550/202006/1576550-20200618222306107-264946586.png" alt="JwtBearer"></a></p>
<h2 id="Bearer认证"><a href="#Bearer认证" class="headerlink" title="Bearer认证"></a>Bearer认证</h2><p>本文要介绍的<strong>Bearer</strong>验证也属于HTTP协议标准验证，它随着OAuth协议而开始流行，详细定义见： <a target="_blank" rel="noopener" href="https://tools.ietf.org/html/rfc6750#section-1.2">RFC 6570</a>。</p>
<pre><code>     +--------+                               +---------------+
     |        |--(A)- Authorization Request -&gt;|   Resource    |
     |        |                               |     Owner     |
     |        |&lt;-(B)-- Authorization Grant ---|               |
     |        |                               +---------------+
     |        |
     |        |                               +---------------+
     |        |--(C)-- Authorization Grant --&gt;| Authorization |
     | Client |                               |     Server    |
     |        |&lt;-(D)----- Access Token -------|               |
     |        |                               +---------------+
     |        |
     |        |                               +---------------+
     |        |--(E)----- Access Token ------&gt;|    Resource   |
     |        |                               |     Server    |
     |        |&lt;-(F)--- Protected Resource ---|               |
     +--------+                               +---------------+</code></pre>
<blockquote>
<p>A security token with the property that any party in possession of the token (a “bearer”) can use the token in any way that any other party in possession of it can. Using a bearer token does not require a bearer to prove possession of cryptographic key material (proof-of-possession).</p>
</blockquote>
<p>因此Bearer认证的核心是Token，Bearer验证中的凭证称为<code>BEARER_TOKEN</code>，或者是<code>access_token</code>，它的颁发和验证完全由我们自己的应用程序来控制，而不依赖于系统和Web服务器，Bearer验证的标准请求方式如下：</p>
<pre class=" language-text"><code class="language-text">Authorization: Bearer [BEARER_TOKEN] </code></pre>
<p>那么使用Bearer验证有什么好处呢？</p>
<ul>
<li>CORS: cookies + CORS 并不能跨不同的域名。而Bearer验证在任何域名下都可以使用HTTP header头部来传输用户信息。</li>
<li>对移动端友好: 当你在一个原生平台(iOS, Android, WindowsPhone等)时，使用Cookie验证并不是一个好主意，因为你得和Cookie容器打交道，而使用Bearer验证则简单的多。</li>
<li>CSRF: 因为Bearer验证不再依赖于cookies, 也就避免了跨站请求攻击。</li>
<li>标准：在Cookie认证中，用户未登录时，返回一个<code>302</code>到登录页面，这在非浏览器情况下很难处理，而Bearer验证则返回的是标准的<code>401 challenge</code>。</li>
</ul>
<h2 id="JWT"><a href="#JWT" class="headerlink" title="JWT"></a>JWT</h2><p>上面介绍的Bearer认证，其核心便是<strong>BEARER_TOKEN</strong>，那么，如何确保Token的安全是重中之重。一种是通过HTTPS的方式，另一种是通过对Token进行加密编码签名，而最流行的Token编码签名方式便是：JSON WEB TOKEN。</p>
<blockquote>
<p>Json web token (Jwt), 是为了在网络应用环境间传递声明而执行的一种基于JSON的开放标准（<a target="_blank" rel="noopener" href="https://tools.ietf.org/html/rfc7519">RFC 7519</a>）。该token被设计为紧凑且安全的，特别适用于分布式站点的单点登录（SSO）场景。JWT的声明一般被用来在身份提供者和服务提供者间传递被认证的用户身份信息，以便于从资源服务器获取资源，也可以增加一些额外的其它业务逻辑所必须的声明信息，该token也可直接被用于认证，也可被加密。</p>
</blockquote>
<p>JWT是由<code>.</code>分割的如下三部分组成：</p>
<pre class=" language-javascript"><code class="language-javascript">Header<span class="token punctuation">.</span>Payload<span class="token punctuation">.</span>Signature</code></pre>
<p><a target="_blank" rel="noopener" href="https://img2020.cnblogs.com/blog/1576550/202006/1576550-20200618211913237-96702827.png"><img src="https://img2020.cnblogs.com/blog/1576550/202006/1576550-20200618211913237-96702827.png" alt="JwtBearer"></a></p>
<p>还记得之前说个的一篇<a target="_blank" rel="noopener" href="https://www.cnblogs.com/i3yuan/p/11519431.html">认证方案之初步认识JWT</a>吗？没有的，可以看看，对JWT的特点和基本原理介绍，可以进一步的了解。</p>
<p>学习了之前的文章后，我们可以发现使用JWT的好处在于通用性、紧凑性和可拓展性。</p>
<ul>
<li><strong>通用性</strong>：因为json的通用性，所以JWT是可以进行跨语言支持的，像JAVA,JavaScript,NodeJS,PHP等很多语言都可以使用。</li>
<li><strong>紧凑性</strong>：JWT的构成非常简单，字节占用很小，通过 GET、POST 等放在 HTTP 的 header 中，便于传输。</li>
<li><strong>可扩展性</strong>：JWT是自我包涵的，因为有了payload部分，包含了必要的一些其他业务逻辑所必要的非敏感信息，自身存储，不需要在服务端保存会话信息, 非常易于应用的扩展。</li>
</ul>
<h2 id="开始"><a href="#开始" class="headerlink" title="开始"></a>开始</h2><h3 id="1-注册认证服务"><a href="#1-注册认证服务" class="headerlink" title="1. 注册认证服务"></a>1. 注册认证服务</h3><p>在这里，我们用微软给我们提供的JwtBearer认证方式，实现认证服务注册 。</p>
<pre class=" language-csharp"><code class="language-csharp">引入nuget包：Microsoft<span class="token punctuation">.</span>AspNetCore<span class="token punctuation">.</span>Authentication<span class="token punctuation">.</span>JwtBearer</code></pre>
<p>注册服务，将服务添加到容器中，</p>
<pre class=" language-csharp"><code class="language-csharp">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">ConfigureServices</span><span class="token punctuation">(</span>IServiceCollection services<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        services<span class="token punctuation">.</span><span class="token function">AddControllers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">var</span> Issurer <span class="token operator">=</span> <span class="token string">"JWTBearer.Auth"</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">//发行人</span>
        <span class="token keyword">var</span> Audience <span class="token operator">=</span> <span class="token string">"api.auth"</span><span class="token punctuation">;</span>       <span class="token comment" spellcheck="true">//受众人</span>
        <span class="token keyword">var</span> secretCredentials <span class="token operator">=</span> <span class="token string">"q2xiARx$4x3TKqBJ"</span><span class="token punctuation">;</span>   <span class="token comment" spellcheck="true">//密钥</span>

        <span class="token comment" spellcheck="true">//配置认证服务</span>
        services<span class="token punctuation">.</span><span class="token function">AddAuthentication</span><span class="token punctuation">(</span>x <span class="token operator">=</span><span class="token operator">></span>
        <span class="token punctuation">{</span>
            x<span class="token punctuation">.</span>DefaultAuthenticateScheme <span class="token operator">=</span> JwtBearerDefaults<span class="token punctuation">.</span>AuthenticationScheme<span class="token punctuation">;</span>
            x<span class="token punctuation">.</span>DefaultChallengeScheme <span class="token operator">=</span> JwtBearerDefaults<span class="token punctuation">.</span>AuthenticationScheme<span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">AddJwtBearer</span><span class="token punctuation">(</span>o<span class="token operator">=</span><span class="token operator">></span><span class="token punctuation">{</span>
            o<span class="token punctuation">.</span>TokenValidationParameters <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TokenValidationParameters</span>
            <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">//是否验证发行人</span>
                ValidateIssuer <span class="token operator">=</span> <span class="token keyword">true</span><span class="token punctuation">,</span>
                ValidIssuer <span class="token operator">=</span> Issurer<span class="token punctuation">,</span><span class="token comment" spellcheck="true">//发行人</span>
                <span class="token comment" spellcheck="true">//是否验证受众人</span>
                ValidateAudience <span class="token operator">=</span> <span class="token keyword">true</span><span class="token punctuation">,</span>
                ValidAudience <span class="token operator">=</span> Audience<span class="token punctuation">,</span><span class="token comment" spellcheck="true">//受众人</span>
                <span class="token comment" spellcheck="true">//是否验证密钥</span>
                ValidateIssuerSigningKey <span class="token operator">=</span> <span class="token keyword">true</span><span class="token punctuation">,</span>
                IssuerSigningKey <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SymmetricSecurityKey</span><span class="token punctuation">(</span>Encoding<span class="token punctuation">.</span>ASCII<span class="token punctuation">.</span><span class="token function">GetBytes</span><span class="token punctuation">(</span>secretCredentials<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>

                ValidateLifetime <span class="token operator">=</span> <span class="token keyword">true</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">//验证生命周期</span>
                RequireExpirationTime <span class="token operator">=</span> <span class="token keyword">true</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">//过期时间</span>
            <span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>注意说明：</p>
<pre><code>一. TokenValidationParameters的参数默认值：
1. ValidateAudience = true,  ----- 如果设置为false,则不验证Audience受众人
2. ValidateIssuer = true ,   ----- 如果设置为false,则不验证Issuer发布人，但建议不建议这样设置
3. ValidateIssuerSigningKey = false,
4. ValidateLifetime = true,  ----- 是否验证Token有效期，使用当前时间与Token的Claims中的NotBefore和Expires对比
5. RequireExpirationTime = true, ----- 是否要求Token的Claims中必须包含Expires
6. ClockSkew = TimeSpan.FromSeconds(300), ----- 允许服务器时间偏移量300秒，即我们配置的过期时间加上这个允许偏移的时间值，才是真正过期的时间(过期时间 +偏移值)你也可以设置为0，ClockSkew = TimeSpan.Zero</code></pre>
<p>调用方法，配置Http请求管道：</p>
<pre class=" language-csharp"><code class="language-csharp">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">Configure</span><span class="token punctuation">(</span>IApplicationBuilder app<span class="token punctuation">,</span> IWebHostEnvironment env<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>env<span class="token punctuation">.</span><span class="token function">IsDevelopment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            app<span class="token punctuation">.</span><span class="token function">UseDeveloperExceptionPage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        app<span class="token punctuation">.</span><span class="token function">UseRouting</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">//1.先开启认证</span>
        app<span class="token punctuation">.</span><span class="token function">UseAuthentication</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">//2.再开启授权</span>
        app<span class="token punctuation">.</span><span class="token function">UseAuthorization</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        app<span class="token punctuation">.</span><span class="token function">UseEndpoints</span><span class="token punctuation">(</span>endpoints <span class="token operator">=</span><span class="token operator">></span>
        <span class="token punctuation">{</span>
            endpoints<span class="token punctuation">.</span><span class="token function">MapControllers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>在<code>JwtBearerOptions</code>的配置中，通常<code>IssuerSigningKey(签名秘钥)</code>, <code>ValidIssuer(Token颁发机构)</code>, <code>ValidAudience(颁发给谁)</code> 三个参数是必须的，后两者用于与TokenClaims中的<code>Issuer</code>和<code>Audience</code>进行对比，不一致则验证失败。</p>
<h3 id="2-接口资源保护"><a href="#2-接口资源保护" class="headerlink" title="2.接口资源保护"></a>2.接口资源保护</h3><p>创建一个需要授权保护的资源控制器，这里我们用建立API生成项目自带的控制器，WeatherForecastController.cs, 在控制器上使用<code>Authorize</code>即可</p>
<pre class=" language-csharp"><code class="language-csharp"><span class="token punctuation">[</span>ApiController<span class="token punctuation">]</span>
<span class="token punctuation">[</span><span class="token function">Route</span><span class="token punctuation">(</span><span class="token string">"[controller]"</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
<span class="token punctuation">[</span>Authorize<span class="token punctuation">]</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WeatherForecastController</span> <span class="token punctuation">:</span> ControllerBase
<span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">readonly</span> <span class="token keyword">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span> Summaries <span class="token operator">=</span> <span class="token keyword">new</span><span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token punctuation">{</span>
        <span class="token string">"Freezing"</span><span class="token punctuation">,</span> <span class="token string">"Bracing"</span><span class="token punctuation">,</span> <span class="token string">"Chilly"</span><span class="token punctuation">,</span> <span class="token string">"Cool"</span><span class="token punctuation">,</span> <span class="token string">"Mild"</span><span class="token punctuation">,</span> <span class="token string">"Warm"</span><span class="token punctuation">,</span> <span class="token string">"Balmy"</span><span class="token punctuation">,</span> <span class="token string">"Hot"</span><span class="token punctuation">,</span> <span class="token string">"Sweltering"</span><span class="token punctuation">,</span> <span class="token string">"Scorching"</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">readonly</span> ILogger<span class="token operator">&lt;</span>WeatherForecastController<span class="token operator">></span> _logger<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token function">WeatherForecastController</span><span class="token punctuation">(</span>ILogger<span class="token operator">&lt;</span>WeatherForecastController<span class="token operator">></span> logger<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        _logger <span class="token operator">=</span> logger<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token punctuation">[</span>HttpGet<span class="token punctuation">]</span>
    <span class="token keyword">public</span> IEnumerable<span class="token operator">&lt;</span>WeatherForecast<span class="token operator">></span> <span class="token function">Get</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">var</span> rng <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> Enumerable<span class="token punctuation">.</span><span class="token function">Range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Select</span><span class="token punctuation">(</span>index <span class="token operator">=</span><span class="token operator">></span> <span class="token keyword">new</span> <span class="token class-name">WeatherForecast</span>
        <span class="token punctuation">{</span>
            Date <span class="token operator">=</span> DateTime<span class="token punctuation">.</span>Now<span class="token punctuation">.</span><span class="token function">AddDays</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">,</span>
            TemperatureC <span class="token operator">=</span> rng<span class="token punctuation">.</span><span class="token function">Next</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">55</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            Summary <span class="token operator">=</span> Summaries<span class="token punctuation">[</span>rng<span class="token punctuation">.</span><span class="token function">Next</span><span class="token punctuation">(</span>Summaries<span class="token punctuation">.</span>Length<span class="token punctuation">)</span><span class="token punctuation">]</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">ToArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<h3 id="3-生成Token"><a href="#3-生成Token" class="headerlink" title="3. 生成Token"></a>3. 生成Token</h3><p>因为微软为我们内置了JwtBearer验证，但是没有提供Token的发放，所以这里我们要实现生成Token的方法</p>
<pre class=" language-csharp"><code class="language-csharp">引入Nugets包：System<span class="token punctuation">.</span>IdentityModel<span class="token punctuation">.</span>Tokens<span class="token punctuation">.</span>Jwt</code></pre>
<p>这里我们根据<a target="_blank" rel="noopener" href="https://github.com/AzureAD/azure-activedirectory-identitymodel-extensions-for-dotnet/blob/dev/src/System.IdentityModel.Tokens.Jwt/JwtSecurityTokenHandler.cs">IdentityModel.Tokens.Jwt</a>文档给我们提供的帮助类，提供了方法WriteToken创建Token，根据参数SecurityToken，可以实例化，JwtSecurityToken，指定可选参数的类。</p>
<pre class=" language-csharp"><code class="language-csharp">        <span class="token comment" spellcheck="true">/// &lt;summary></span>
        <span class="token comment" spellcheck="true">/// Initializes a new instance of the &lt;see cref="JwtSecurityToken"/> class specifying optional parameters.</span>
        <span class="token comment" spellcheck="true">/// &lt;/summary></span>
        <span class="token comment" spellcheck="true">/// &lt;param name="issuer">If this value is not null, a { iss, 'issuer' } claim will be added, overwriting any 'iss' claim in 'claims' if present.&lt;/param></span>
        <span class="token comment" spellcheck="true">/// &lt;param name="audience">If this value is not null, a { aud, 'audience' } claim will be added, appending to any 'aud' claims in 'claims' if present.&lt;/param></span>
        <span class="token comment" spellcheck="true">/// &lt;param name="claims">If this value is not null then for each &lt;see cref="Claim"/> a { 'Claim.Type', 'Claim.Value' } is added. If duplicate claims are found then a { 'Claim.Type', List&amp;lt;object&amp;gt; } will be created to contain the duplicate values.&lt;/param></span>
        <span class="token comment" spellcheck="true">/// &lt;param name="expires">If expires.HasValue a { exp, 'value' } claim is added, overwriting any 'exp' claim in 'claims' if present.&lt;/param></span>
        <span class="token comment" spellcheck="true">/// &lt;param name="notBefore">If notbefore.HasValue a { nbf, 'value' } claim is added, overwriting any 'nbf' claim in 'claims' if present.&lt;/param></span>
        <span class="token comment" spellcheck="true">/// &lt;param name="signingCredentials">The &lt;see cref="SigningCredentials"/> that will be used to sign the &lt;see cref="JwtSecurityToken"/>. See &lt;see cref="JwtHeader(SigningCredentials)"/> for details pertaining to the Header Parameter(s).&lt;/param></span>
        <span class="token comment" spellcheck="true">/// &lt;exception cref="ArgumentException">If 'expires' &amp;lt;= 'notbefore'.&lt;/exception></span>
        <span class="token keyword">public</span> <span class="token function">JwtSecurityToken</span><span class="token punctuation">(</span><span class="token keyword">string</span> issuer <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">string</span> audience <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">,</span> IEnumerable<span class="token operator">&lt;</span>Claim<span class="token operator">></span> claims <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">,</span> DateTime<span class="token operator">?</span> notBefore <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">,</span> DateTime<span class="token operator">?</span> expires <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">,</span> SigningCredentials signingCredentials <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>expires<span class="token punctuation">.</span>HasValue <span class="token operator">&amp;&amp;</span> notBefore<span class="token punctuation">.</span>HasValue<span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>notBefore <span class="token operator">>=</span> expires<span class="token punctuation">)</span>
                    <span class="token keyword">throw</span> LogHelper<span class="token punctuation">.</span><span class="token function">LogExceptionMessage</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ArgumentException</span><span class="token punctuation">(</span>LogHelper<span class="token punctuation">.</span><span class="token function">FormatInvariant</span><span class="token punctuation">(</span>LogMessages<span class="token punctuation">.</span>IDX12401<span class="token punctuation">,</span> expires<span class="token punctuation">.</span>Value<span class="token punctuation">,</span> notBefore<span class="token punctuation">.</span>Value<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            Payload <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JwtPayload</span><span class="token punctuation">(</span>issuer<span class="token punctuation">,</span> audience<span class="token punctuation">,</span> claims<span class="token punctuation">,</span> notBefore<span class="token punctuation">,</span> expires<span class="token punctuation">)</span><span class="token punctuation">;</span>
            Header <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JwtHeader</span><span class="token punctuation">(</span>signingCredentials<span class="token punctuation">)</span><span class="token punctuation">;</span>
            RawSignature <span class="token operator">=</span> <span class="token keyword">string</span><span class="token punctuation">.</span>Empty<span class="token punctuation">;</span>
        <span class="token punctuation">}</span></code></pre>
<p>这样，我们可以根据参数指定内容：</p>
<pre class=" language-csharp"><code class="language-csharp"><span class="token number">1</span><span class="token punctuation">.</span> <span class="token keyword">string</span> iss <span class="token operator">=</span> <span class="token string">"JWTBearer.Auth"</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// 定义发行人</span>
<span class="token number">2</span><span class="token punctuation">.</span> <span class="token keyword">string</span> aud <span class="token operator">=</span> <span class="token string">"api.auth"</span><span class="token punctuation">;</span>       <span class="token comment" spellcheck="true">//定义受众人audience</span>
<span class="token number">3</span><span class="token punctuation">.</span> IEnumerable<span class="token operator">&lt;</span>Claim<span class="token operator">></span> claims <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Claim</span><span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token punctuation">{</span>
<span class="token keyword">new</span> <span class="token class-name">Claim</span><span class="token punctuation">(</span>JwtClaimTypes<span class="token punctuation">.</span>Id<span class="token punctuation">,</span><span class="token string">"1"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token keyword">new</span> <span class="token class-name">Claim</span><span class="token punctuation">(</span>JwtClaimTypes<span class="token punctuation">.</span>Name<span class="token punctuation">,</span><span class="token string">"i3yuan"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//定义许多种的声明Claim,信息存储部分,Claims的实体一般包含用户和一些元数据</span>
<span class="token number">4</span><span class="token punctuation">.</span> <span class="token keyword">var</span> nbf <span class="token operator">=</span> DateTime<span class="token punctuation">.</span>UtcNow<span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">//notBefore  生效时间</span>
<span class="token number">5</span><span class="token punctuation">.</span> <span class="token keyword">var</span> Exp <span class="token operator">=</span> DateTime<span class="token punctuation">.</span>UtcNow<span class="token punctuation">.</span><span class="token function">AddSeconds</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">//expires 过期时间</span>
<span class="token number">6</span><span class="token punctuation">.</span> <span class="token keyword">string</span> sign <span class="token operator">=</span> <span class="token string">"q2xiARx$4x3TKqBJ"</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//SecurityKey 的长度必须 大于等于 16个字符</span>
 <span class="token keyword">var</span> secret <span class="token operator">=</span> Encoding<span class="token punctuation">.</span>UTF8<span class="token punctuation">.</span><span class="token function">GetBytes</span><span class="token punctuation">(</span>sign<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">var</span> key <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SymmetricSecurityKey</span><span class="token punctuation">(</span>secret<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">var</span> signcreds <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SigningCredentials</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> SecurityAlgorithms<span class="token punctuation">.</span>HmacSha256<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>好了，通过以上填充参数内容，进行传参赋值得到，完整代码如下：</p>
<p>新增AuthController.cs控制器：</p>
<pre class=" language-csharp"><code class="language-csharp">    <span class="token punctuation">[</span>HttpGet<span class="token punctuation">]</span>
    <span class="token keyword">public</span> IActionResult <span class="token function">GetToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">try</span>
        <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">//定义发行人issuer</span>
            <span class="token keyword">string</span> iss <span class="token operator">=</span> <span class="token string">"JWTBearer.Auth"</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">//定义受众人audience</span>
            <span class="token keyword">string</span> aud <span class="token operator">=</span> <span class="token string">"api.auth"</span><span class="token punctuation">;</span>

            <span class="token comment" spellcheck="true">//定义许多种的声明Claim,信息存储部分,Claims的实体一般包含用户和一些元数据</span>
            IEnumerable<span class="token operator">&lt;</span>Claim<span class="token operator">></span> claims <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Claim</span><span class="token punctuation">[</span><span class="token punctuation">]</span>
            <span class="token punctuation">{</span>
                <span class="token keyword">new</span> <span class="token class-name">Claim</span><span class="token punctuation">(</span>JwtClaimTypes<span class="token punctuation">.</span>Id<span class="token punctuation">,</span><span class="token string">"1"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token keyword">new</span> <span class="token class-name">Claim</span><span class="token punctuation">(</span>JwtClaimTypes<span class="token punctuation">.</span>Name<span class="token punctuation">,</span><span class="token string">"i3yuan"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">//notBefore  生效时间</span>
            <span class="token comment" spellcheck="true">// long nbf =new DateTimeOffset(DateTime.Now).ToUnixTimeSeconds();</span>
            <span class="token keyword">var</span> nbf <span class="token operator">=</span> DateTime<span class="token punctuation">.</span>UtcNow<span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">//expires   //过期时间</span>
            <span class="token comment" spellcheck="true">// long Exp = new DateTimeOffset(DateTime.Now.AddSeconds(1000)).ToUnixTimeSeconds();</span>
            <span class="token keyword">var</span> Exp <span class="token operator">=</span> DateTime<span class="token punctuation">.</span>UtcNow<span class="token punctuation">.</span><span class="token function">AddSeconds</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">//signingCredentials  签名凭证</span>
            <span class="token keyword">string</span> sign <span class="token operator">=</span> <span class="token string">"q2xiARx$4x3TKqBJ"</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//SecurityKey 的长度必须 大于等于 16个字符</span>
            <span class="token keyword">var</span> secret <span class="token operator">=</span> Encoding<span class="token punctuation">.</span>UTF8<span class="token punctuation">.</span><span class="token function">GetBytes</span><span class="token punctuation">(</span>sign<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">var</span> key <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SymmetricSecurityKey</span><span class="token punctuation">(</span>secret<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">var</span> signcreds <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SigningCredentials</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> SecurityAlgorithms<span class="token punctuation">.</span>HmacSha256<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">var</span> jwt <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JwtSecurityToken</span><span class="token punctuation">(</span>issuer<span class="token punctuation">:</span> iss<span class="token punctuation">,</span> audience<span class="token punctuation">:</span> aud<span class="token punctuation">,</span> claims<span class="token punctuation">:</span>claims<span class="token punctuation">,</span>notBefore<span class="token punctuation">:</span>nbf<span class="token punctuation">,</span>expires<span class="token punctuation">:</span>Exp<span class="token punctuation">,</span> signingCredentials<span class="token punctuation">:</span> signcreds<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">var</span> JwtHander <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JwtSecurityTokenHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">var</span> token <span class="token operator">=</span> JwtHander<span class="token punctuation">.</span><span class="token function">WriteToken</span><span class="token punctuation">(</span>jwt<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token function">Ok</span><span class="token punctuation">(</span><span class="token keyword">new</span>
            <span class="token punctuation">{</span>
                access_token <span class="token operator">=</span> token<span class="token punctuation">,</span>
                token_type <span class="token operator">=</span> <span class="token string">"Bearer"</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> ex<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">throw</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre>
<blockquote>
<pre><code>注意：
1.SecurityKey 的长度必须 大于等于 16个字符，否则生成会报错。（可通过在线随机生成密钥）</code></pre>
</blockquote>
<h2 id="运行"><a href="#运行" class="headerlink" title="运行"></a>运行</h2><p><strong>访问获取Token方法，获取得到access_token:</strong></p>
<p><a target="_blank" rel="noopener" href="https://img2020.cnblogs.com/blog/1576550/202006/1576550-20200618211533536-1484568585.png"><img src="https://img2020.cnblogs.com/blog/1576550/202006/1576550-20200618211533536-1484568585.png" alt="JwtBearer"></a></p>
<p><strong>再访问，授权资源接口，可以发现，再没有添加请求头token值的情况下，返回了401没有权限。</strong></p>
<p><a target="_blank" rel="noopener" href="https://img2020.cnblogs.com/blog/1576550/202006/1576550-20200618211545989-228060775.png"><img src="https://img2020.cnblogs.com/blog/1576550/202006/1576550-20200618211545989-228060775.png" alt="JwtBearer"></a></p>
<p><strong>这次，在请求头通过Authorization加上之前获取的token值后，再次进行访问，发现已经可以获取访问资源控制器，并返回对应的数据。</strong></p>
<p><a target="_blank" rel="noopener" href="https://img2020.cnblogs.com/blog/1576550/202006/1576550-20200618211558633-293363451.png"><img src="https://img2020.cnblogs.com/blog/1576550/202006/1576550-20200618211558633-293363451.png" alt="JwtBearer"></a></p>
<h2 id="扩展说明"><a href="#扩展说明" class="headerlink" title="扩展说明"></a>扩展说明</h2><p>在HTTP标准验证方案中，我们比较熟悉的是”Basic”和”Digest”，前者将用户名密码使用BASE64编码后作为验证凭证，后者是Basic的升级版，更加安全，因为Basic是明文传输密码信息，而Digest是加密后传输。</p>
<h3 id="一、Basic基础认证"><a href="#一、Basic基础认证" class="headerlink" title="一、Basic基础认证"></a>一、Basic基础认证</h3><p>Basic认证是一种较为简单的HTTP认证方式，客户端通过明文（Base64编码格式）传输用户名和密码到服务端进行认证，通常需要配合HTTPS来保证信息传输的安全。</p>
<p>客户端请求需要带Authorization请求头，值为“Basic xxx”，xxx为“用户名:密码”进行Base64编码后生成的值。 若客户端是浏览器，则浏览器会提供一个输入用户名和密码的对话框，用户输入用户名和密码后，浏览器会保存用户名和密码，用于构造Authorization值。当关闭浏览器后，用户名和密码将不再保存。</p>
<p>凭证为“YWxhzGRpbjpvcGVuc2VzYWl1”，是通过将“用户名:密码”格式的字符串经过的Base64编码得到的。而Base64不属于加密范畴，可以被逆向解码，等同于明文，因此Basic传输认证信息是不安全的。</p>
<p>Basic基础认证图示：</p>
<p><a target="_blank" rel="noopener" href="https://img2020.cnblogs.com/blog/1576550/202006/1576550-20200618211748571-633028335.png"><img src="https://img2020.cnblogs.com/blog/1576550/202006/1576550-20200618211748571-633028335.png" alt="JwtBearer"></a></p>
<p>缺陷汇总<br>1.用户名和密码明文（Base64）传输，需要配合HTTPS来保证信息传输的安全。<br>2.即使密码被强加密，第三方仍可通过加密后的用户名和密码进行重放攻击。<br>3.没有提供任何针对代理和中间节点的防护措施。<br>4.假冒服务器很容易骗过认证，诱导用户输入用户名和密码。</p>
<h3 id="二、Digest摘要认证"><a href="#二、Digest摘要认证" class="headerlink" title="二、Digest摘要认证"></a><strong>二、Digest摘要认证</strong></h3><p>Digest认证是为了修复基本认证协议的严重缺陷而设计的，秉承“绝不通过明文在网络发送密码”的原则，通过“密码摘要”进行认证，大大提高了安全性。</p>
<p>Digest认证步骤如下：<br>第一步：客户端访问Http资源服务器。由于需要Digest认证，服务器返回了两个重要字段nonce（随机数）和realm。<br>第二步：客户端构造Authorization请求头，值包含username、realm、nouce、uri和response的字段信息。其中，realm和nouce就是第一步返回的值。nouce只能被服务端使用一次。uri(digest-uri)即Request-URI的值，但考虑到经代理转发后Request-URI的值可能被修改、因此实现会复制一份副本保存在uri内。response也可叫做Request-digest，存放经过MD5运算后的密码字符串，形成响应码。<br>第三步：服务器验证包含Authorization值的请求，若验证通过则可访问资源。<br>Digest认证可以防止密码泄露和请求重放，但没办法防假冒。所以安全级别较低。<br>Digest和Basic认证一样，每次都会发送Authorization请求头，也就相当于重新构造此值。所以两者易用性都较差。</p>
<p>Digest认证图示：<br><a target="_blank" rel="noopener" href="https://img2020.cnblogs.com/blog/1576550/202006/1576550-20200618215349761-1821279766.png"><img src="https://img2020.cnblogs.com/blog/1576550/202006/1576550-20200618215349761-1821279766.png" alt="JwtBearer"></a></p>
<h2 id="注意"><a href="#注意" class="headerlink" title="注意"></a>注意</h2><ol>
<li>在进行JwtBearer认证时，在生成token之后，还需要与刷新token配合使用，因为当用户执行了退出，修改密码等操作时，需要让该token无效，无法再次使用，所以，会给access_token设置一个较短的有效期间，(JwtBearer认证默认会验证有效期，通过<code>notBefore</code>和<code>expires</code>来验证)，当<code>access_token</code>过期后，可以在用户无感知的情况下，使用<code>refresh_token</code>重新获取<code>access_token</code>，但这就不属于Bearer认证的范畴了，但是我们可以通过另一种方式通过IdentityServer的方式来实现，在后续中会对IdentityServer进行详细讲解。</li>
<li>在生成token的时候，需要用的secret，主要是用来防止token被伪造与篡改。因为当token被劫取的时候，可以得到你的令牌中带的一些个人不重要的信息明文，但不用担心，只要你不在生成token里把私密的个人信息放出去的话，就算被动机不良的人得到，也做不了什么事情。但是你可能会想，如果用户自己随便的生成一个 token ，带上你的信息，那不就可以随便访问你的资源服务器了，因此这个时候就需要利用secret 来生成 token，来确保数字签名的正确性。而且在认证授权资源，进行token解析的时候，通过微软的源码发现，已经帮我们封装了方法，对secret进行了校验了，确保了token的安全性，从而保证api资源的安全。</li>
</ol>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><ol>
<li>JwtToken在认证时，无需Security token service安全令牌服务器的参与，都是基于Claim的，默认会验证有效期，通过<code>notBefore</code>和<code>expires</code>来验证，这在分布式中提供给了极大便利。</li>
<li>JwtToken与平台、无言无关，在前端也可以直接解析出Claims。</li>
<li>如果有不对的或不理解的地方，希望大家可以多多指正，提出问题，一起讨论,不断学习,共同进步。</li>
<li>后面会对认证授权方案中的授权这一块进行说明分享。</li>
<li>本示例<a target="_blank" rel="noopener" href="https://files-cdn.cnblogs.com/files/i3yuan/Auth.Token.rar">源码地址</a><br>参考<a target="_blank" rel="noopener" href="https://github.com/aspnet/Security/tree/master/src/Microsoft.AspNetCore.Authentication.JwtBearer">JwtBearer</a>源码</li>
</ol>

            </div>
            <hr/>

            

    <div class="reprint" id="reprint-statement">
        
            <div class="reprint__author">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-user">
                        文章作者:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="/about" rel="external nofollow noreferrer">艾三元</a>
                </span>
            </div>
            <div class="reprint__type">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-link">
                        文章链接:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="https://i3yuan.github.io/2020/06/19/ji-yu.netcore3.1-xi-lie-ren-zheng-shou-quan-fang-an-zhi-jwtbearer-ren-zheng/">https://i3yuan.github.io/2020/06/19/ji-yu.netcore3.1-xi-lie-ren-zheng-shou-quan-fang-an-zhi-jwtbearer-ren-zheng/</a>
                </span>
            </div>
            <div class="reprint__notice">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-copyright">
                        版权声明:
                    </i>
                </span>
                <span class="reprint-info">
                    本博客所有文章除特別声明外，均采用
                    <a href="https://creativecommons.org/licenses/by/4.0/deed.zh" rel="external nofollow noreferrer" target="_blank">CC BY 4.0</a>
                    许可协议。转载请注明来源
                    <a href="/about" target="_blank">艾三元</a>
                    !
                </span>
            </div>
        
    </div>

    <script async defer>
      document.addEventListener("copy", function (e) {
        let toastHTML = '<span>复制成功，请遵循本文的转载规则</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">查看</a>';
        M.toast({html: toastHTML})
      });

      function navToReprintStatement() {
        $("html, body").animate({scrollTop: $("#reprint-statement").offset().top - 80}, 800);
      }
    </script>



            <div class="tag_share" style="display: block;">
                <div class="post-meta__tag-list" style="display: inline-block;">
                    
                        <div class="article-tag">
                            
                                <a href="/tags/net-core/">
                                    <span class="chip bg-color">.net core</span>
                                </a>
                            
                                <a href="/tags/JWT%E8%AE%A4%E8%AF%81%E6%8E%88%E6%9D%83/">
                                    <span class="chip bg-color">JWT认证授权</span>
                                </a>
                            
                        </div>
                    
                </div>
                <div class="post_share" style="zoom: 80%; width: fit-content; display: inline-block; float: right; margin: -0.15rem 0;">
                    <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">
<div id="article-share">

    
    <div class="social-share" data-sites="twitter,facebook,google,qq,qzone,wechat,weibo,douban,linkedin" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div>
    <script src="/libs/share/js/social-share.min.js"></script>
    

    

</div>

                </div>
            </div>
            
        </div>
    </div>

    

    

    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fas fa-chevron-left"></i>&nbsp;上一篇</div>
            <div class="card">
                <a href="/2020/06/28/ji-yu.netcore3.1-xi-lie-ren-zheng-shou-quan-fang-an-zhi-shou-quan-chu-shi/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/39.jpg" class="responsive-img" alt="基于.NetCore3.1系列 —— 认证授权方案之授权初识">
                        
                        <span class="card-title">基于.NetCore3.1系列 —— 认证授权方案之授权初识</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            基于.NetCore3.1系列 —— 认证授权方案之授权初识前言回顾：认证授权方案之JwtBearer认证

在上一篇中，我们通过JwtBearer的方式认证，了解在认证时，都是基于Claim的，因此我们可以通过用户令牌获取到用户的Clai
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="far fa-clock fa-fw icon-date"></i>2020-06-28
                        </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/DotCore-C/" class="post-category">
                                    DotCore/C#
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/net-core/">
                        <span class="chip bg-color">.net core</span>
                    </a>
                    
                    <a href="/tags/JWT%E8%AE%A4%E8%AF%81%E6%8E%88%E6%9D%83/">
                        <span class="chip bg-color">JWT认证授权</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fas fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2020/06/12/c-ji-chu-pian-shi-jian/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/8.jpg" class="responsive-img" alt="C#基础篇——事件">
                        
                        <span class="card-title">C#基础篇——事件</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            C#基础篇——事件前言在本章中，主要是借机这个C#基础篇的系列整理过去的学习笔记、归纳总结并更加理解透彻。
在上一篇文章，我们已经对委托有了进一步了解，委托相当于用方法作为另一方法参数，同时，也可以实现在两个不能直接调用的方法中做桥梁。
下
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2020-06-12
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/Net-C/" class="post-category">
                                    .Net/C#
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/C-%E5%9F%BA%E7%A1%80%E7%AF%87/">
                        <span class="chip bg-color">C#基础篇</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>



<!-- 代码块功能依赖 -->
<script type="text/javascript" src="/libs/codeBlock/codeBlockFuction.js"></script>

<!-- 代码语言 -->

<script type="text/javascript" src="/libs/codeBlock/codeLang.js"></script>


<!-- 代码块复制 -->

<script type="text/javascript" src="/libs/codeBlock/codeCopy.js"></script>


<!-- 代码块收缩 -->

<script type="text/javascript" src="/libs/codeBlock/codeShrink.js"></script>


<!-- 代码块折行 -->

<style type="text/css">
code[class*="language-"], pre[class*="language-"] { white-space: pre !important; }
</style>


    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget">
            <div class="toc-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fas fa-list-ul"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            collapseDepth: Number('0'),
            headingSelector: 'h2, h3, h4'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h2, h3, h4').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).hide();
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).show();
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>




    <footer class="page-footer bg-color">
    
    <div class="container row center-align" style="margin-bottom: 0px !important;">
        <div class="col s12 m8 l8 copy-right">
            Copyright&nbsp;&copy;
            <span id="year">2019</span>
            <a href="/about" target="_blank">艾三元</a>
            <!-- |&nbsp;Powered by&nbsp;<a href="https://hexo.io/" target="_blank">Hexo</a> -->
           <!-- |&nbsp;Theme&nbsp;<a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a>-->
            <br>
            
            
            
            
            
            <br>
            
            <br>
            
        </div>
        <div class="col s12 m4 l4 social-link ">
    <a href="https://github.com/i3yuan" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fab fa-github"></i>
    </a>















</div>
    </div>
</footer>

<div class="progress-bar"></div>


    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fas fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script src="/js/search.js"></script>
<script type="text/javascript">
$(function () {
    searchFunc("/search.xml", 'searchInput', 'searchResult');
});
</script>

    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fas fa-arrow-up"></i>
    </a>
</div>


    <script src="/libs/materialize/materialize.min.js"></script>
    <script src="/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/libs/aos/aos.js"></script>
    <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/js/matery.js"></script>

    <!-- Baidu Analytics -->

    <!-- Baidu Push -->

<script>
    (function () {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
            bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        } else {
            bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script>

    
    <script src="/libs/others/clicklove.js" async="async"></script>
    
    

    

    

    

    

    

    
    <script src="/libs/instantpage/instantpage.js" type="module"></script>
    

</body>

</html>
